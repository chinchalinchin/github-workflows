name: Scan

on: 
  workflow_call:
    secrets:
      ACTIONS_USERNAME:
        required: True
      ACTIONS_EMAIL:
        required: True
      ACTIONS_PAT:
        required: True

jobs:
  checkov:
    runs-on: [self-hosted]
    env:
      USERNAME: ${{ secrets.ACTIONS_USERNAME }}
      EMAIL: ${{ secrets.ACTIONS_EMAIL }}
      TOKEN: ${{ secrets.ACTIONS_PAT }}
    steps:
      - name:
        run: |
          git clone --depth 1 https://${USERNAME}:${TOKEN}@github.boozallencsn.com/AutomationLibrary/aws-synthetics-heartbeat-canary.git
          cd aws-synthetics-heartbeat-canary
      # - name: Clone repo
      #   uses: actions/checkout@v3.0.2
      
      - name: Scan with Checkov
        run: checkov -d .
  
  tfsec:
    runs-on: [self-hosted]
    env:
      USERNAME: ${{ secrets.ACTIONS_USERNAME }}
      EMAIL: ${{ secrets.ACTIONS_EMAIL }}
    steps:
      - name:
        run: |
          git clone --depth 1 https://${USERNAME}:${TOKEN}@github.boozallencsn.com/AutomationLibrary/aws-synthetics-heartbeat-canary.git
          cd aws-synthetics-heartbeat-canary

      # - name: Clone repo
      #   uses: actions/checkout@v3.0.2
      
      - name: Run Terraform Security Scan
        run: tfsec .